// Load environment variables from .env file (for local testing)
require('dotenv').config();

const axios = require('axios');
const OpenAI = require('openai');
const fs = require('fs');
const path = require('path');

// Initialize OpenAI
const openai = new OpenAI({
    apiKey: process.env.OPENAI_API_KEY
});

/**
 * Fetch the daily LeetCode problem
 * Note: LeetCode doesn't have an official public API, so we'll use GraphQL endpoint
 */
async function getDailyProblem() {
    try {
        const query = `
      query questionOfToday {
        activeDailyCodingChallengeQuestion {
          date
          link
          question {
            questionId
            title
            titleSlug
            content
            difficulty
            exampleTestcases
            topicTags {
              name
            }
          }
        }
      }
    `;

        const response = await axios.post('https://leetcode.com/graphql', {
            query: query,
            variables: {}
        }, {
            headers: {
                'Content-Type': 'application/json',
                'Referer': 'https://leetcode.com'
            }
        });

        const data = response.data.data.activeDailyCodingChallengeQuestion;
        return {
            date: data.date,
            title: data.question.title,
            titleSlug: data.question.titleSlug,
            difficulty: data.question.difficulty,
            content: data.question.content,
            link: `https://leetcode.com${data.link}`,
            topicTags: data.question.topicTags.map(tag => tag.name),
            exampleTestcases: data.question.exampleTestcases
        };
    } catch (error) {
        console.error('Error fetching daily problem:', error.message);
        throw error;
    }
}

/**
 * Clean HTML content from problem description
 */
function cleanHTML(html) {
    return html
        .replace(/<[^>]*>/g, '')
        .replace(/&nbsp;/g, ' ')
        .replace(/&lt;/g, '<')
        .replace(/&gt;/g, '>')
        .replace(/&amp;/g, '&')
        .replace(/&quot;/g, '"')
        .trim();
}

/**
 * Use OpenAI to generate a solution
 */
async function generateSolution(problem) {
    try {
        const cleanContent = cleanHTML(problem.content);

        const prompt = `You are an expert programmer solving LeetCode problems. 

Problem: ${problem.title}
Difficulty: ${problem.difficulty}
Topics: ${problem.topicTags.join(', ')}

Description:
${cleanContent}

Please provide:
1. A well-commented JavaScript solution
2. Time complexity analysis
3. Space complexity analysis
4. Brief explanation of the approach

Format your response as a complete JavaScript file with comments.`;

        const completion = await openai.chat.completions.create({
            model: "gpt-4o-mini", // Using gpt-4o-mini for better availability and lower cost
            messages: [
                {
                    role: "system",
                    content: "You are an expert programmer who writes clean, efficient, and well-documented code."
                },
                {
                    role: "user",
                    content: prompt
                }
            ],
            temperature: 0.7,
            max_tokens: 2000
        });

        return completion.choices[0].message.content;
    } catch (error) {
        console.error('Error generating solution:', error.message);
        throw error;
    }
}

/**
 * Save solution to file
 */
function saveSolution(problem, solution) {
    const solutionsDir = path.join(__dirname, '../solutions');

    // Create solutions directory if it doesn't exist
    if (!fs.existsSync(solutionsDir)) {
        fs.mkdirSync(solutionsDir, { recursive: true });
    }

    // Create filename from date and problem title
    const filename = `${problem.date}-${problem.titleSlug}.js`;
    const filepath = path.join(solutionsDir, filename);

    // Create file content with metadata
    const fileContent = `/**
 * LeetCode Daily Challenge - ${problem.date}
 * 
 * Problem: ${problem.title}
 * Difficulty: ${problem.difficulty}
 * Link: ${problem.link}
 * Topics: ${problem.topicTags.join(', ')}
 * 
 * Generated by AI on ${new Date().toISOString()}
 */

${solution}
`;

    fs.writeFileSync(filepath, fileContent, 'utf8');
    console.log(`‚úÖ Solution saved to: ${filename}`);

    return filepath;
}

/**
 * Main function
 */
async function main() {
    try {
        console.log('üöÄ Starting Daily LeetCode Solver...\n');

        // Check if API key is set
        if (!process.env.OPENAI_API_KEY) {
            throw new Error('OPENAI_API_KEY environment variable is not set');
        }

        // Fetch daily problem
        console.log('üì• Fetching daily LeetCode problem...');
        const problem = await getDailyProblem();
        console.log(`‚úÖ Found problem: ${problem.title} (${problem.difficulty})\n`);

        // Generate solution
        console.log('ü§ñ Generating AI solution...');
        const solution = await generateSolution(problem);
        console.log('‚úÖ Solution generated\n');

        // Save solution
        console.log('üíæ Saving solution...');
        const filepath = saveSolution(problem, solution);

        console.log('\n‚ú® Done! Solution ready for commit.');

    } catch (error) {
        console.error('‚ùå Error:', error.message);
        process.exit(1);
    }
}

// Run the script
main();
